local modem = peripheral.wrap("right")
local channel = 1
if not modem then
    print("No modem found!")
    return
end
modem.open(channel)

-- Create a flag file to indicate if the speedometer should be running
local function setSpeedometerFlag(state)
    local file = fs.open("speedometer_flag", "w")
    file.write(state and "1" or "0")
    file.close()
end

-- Get the current flag state
local function getSpeedometerFlag()
    if not fs.exists("speedometer_flag") then
        setSpeedometerFlag(false)
        return false
    end
    
    local file = fs.open("speedometer_flag", "r")
    local state = file.readAll() == "1"
    file.close()
    return state
end

-- Toggle the speedometer flag
local function toggleSpeedometer()
    local currentState = getSpeedometerFlag()
    setSpeedometerFlag(not currentState)
    
    if not currentState then
        -- Starting the speedometer
        print("Starting speedometer...")
        shell.run("animatedspeedometer.lua")
        -- When speedometer exits, reset the flag
        setSpeedometerFlag(false)
        print("Speedometer stopped.")
    end
end

-- Main receiver
while true do
    local event, side, senderChannel, replyChannel, message, distance = os.pullEvent("modem_message")
    if senderChannel == channel and message == "button_pressed" then
        toggleSpeedometer()
    end
end
