local modem = peripheral.wrap("right")
local channel = 1

if not modem then
    print("No modem found!")
    return
end

modem.open(channel)

local speedometerRunning = false
local speedometerActive = false

-- Listen for wireless button
local function runReceiver()
    while true do
        local event, side, senderChannel, replyChannel, message, distance = os.pullEvent("modem_message")
        if senderChannel == channel and message == "button_pressed" then
            os.queueEvent("toggle_speedometer")
        end
    end
end

-- Manage toggling speedometer state
local function manageSpeedometer()
    while true do
        local event = os.pullEvent("toggle_speedometer")

        speedometerRunning = not speedometerRunning
    end
end

-- Actually launch / shutdown speedometer
local function runSpeedometer()
    while true do
        if speedometerRunning and not speedometerActive then
            -- start it
            speedometerActive = true
            shell.run("animatedspeedometer.lua")
            -- when animatedspeedometer exits, set active false
            speedometerActive = false
        elseif not speedometerRunning and speedometerActive then
            -- ask it to shutdown
            os.queueEvent("shutdown_speedometer")
            sleep(0.5) -- Give it a tiny bit to finish
        else
            sleep(0.1) -- nothing to do
        end
    end
end

parallel.waitForAny(runReceiver, manageSpeedometer, runSpeedometer)
