local modem = peripheral.wrap("right")
local channel = 1
if not modem then
    print("No modem found!")
    return
end
modem.open(channel)

-- Create a state file to control the speedometer
local function setSpeedometerState(running)
    local file = fs.open("speedometer_state", "w")
    file.write(running and "running" or "stopped")
    file.close()
end

-- Initialize to stopped state
setSpeedometerState(false)

-- Main loop to handle button presses
while true do
    local event, side, senderChannel, replyChannel, message, distance = os.pullEvent("modem_message")
    
    if senderChannel == channel and message == "button_pressed" then
        -- Read current state
        local file = fs.open("speedometer_state", "r")
        local currentState = file.readAll()
        file.close()
        
        if currentState == "stopped" then
            -- Start the speedometer
            print("Starting speedometer...")
            setSpeedometerState(true)
            shell.run("animatedspeedometer.lua")
            -- When speedometer exits, set state to stopped
            setSpeedometerState(false)
            print("Speedometer stopped.")
        else
            -- Signal the speedometer to stop
            print("Stopping speedometer...")
            setSpeedometerState(false)
            -- The speedometer will see this and stop itself
        end
    end
end
