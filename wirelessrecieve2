-- Correct Wireless Receiver that fully controls animatedspeedometer

local modem = peripheral.wrap("right")
local channel = 1

if not modem then
    print("No modem found!")
    return
end

modem.open(channel)

local speedometerRunning = false
local speedometerThread = nil

local function runReceiver()
    print("Receiver started.")

    while true do
        local event, side, senderChannel, replyChannel, message, distance = os.pullEvent("modem_message")

        if senderChannel == channel and message == "button_pressed" then
            if not speedometerRunning then
                print("Starting Speedometer...")
                os.queueEvent("start_speedometer")
            else
                print("Stopping Speedometer...")
                os.queueEvent("shutdown_speedometer")
            end
        end
    end
end

local function runSpeedometerManager()
    while true do
        local event = os.pullEvent()

        if event == "start_speedometer" and not speedometerRunning then
            speedometerRunning = true
            print("Loading speedometer code...")
            local speedometerFunction = loadfile("animatedspeedometer.lua")
            if not speedometerFunction then
                print("Error loading animatedspeedometer.lua!")
                speedometerRunning = false
            else
                speedometerThread = coroutine.create(speedometerFunction)
                coroutine.resume(speedometerThread)
            end
        elseif event == "shutdown_speedometer" and speedometerRunning then
            print("Sending shutdown event to speedometer...")
            -- Shutdown is handled by the running animatedspeedometer.lua itself
            os.queueEvent("shutdown_speedometer")
        end

        -- Check if speedometer thread is dead
        if speedometerThread and coroutine.status(speedometerThread) == "dead" then
            print("Speedometer thread finished.")
            speedometerRunning = false
            speedometerThread = nil
        end
    end
end

-- Now run both in parallel!
parallel.waitForAny(runReceiver, runSpeedometerManager)
